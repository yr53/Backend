<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.coreon.board.mapper.BoardPostMapper">

    <!-- ✅ SELECT에서만 alias 적용 -->
    <sql id="BoardPostColumns">
        board_id as boardId,
        category,
        title,
        content,
        dept,
        author_id,
        author_name as authorname,
        view_count,
        created_at as createdat,
        updated_at
    </sql>

    <!-- 1) 목록 조회 -->
    <select id="selectPosts" resultType="com.coreon.board.dto.response.BoardPostListItemResponse">
        SELECT
        <include refid="BoardPostColumns"/>
        FROM board_post
        <where>
            <if test="category != null and category != '' and category != 'all'">
                AND category = #{category}
            </if>

            <if test="dept != null and dept != ''">
                AND dept = #{dept}
            </if>

            <if test="authorid != null and authorid != ''">
                AND author_id = #{authorid}
            </if>

            <if test="q != null and q != ''">
                AND (
                    title LIKE CONCAT('%', #{q}, '%')
                    OR content LIKE CONCAT('%', #{q}, '%')
                    OR author_name LIKE CONCAT('%', #{q}, '%')
                    OR dept LIKE CONCAT('%', #{q}, '%')
                )
            </if>
        </where>

        <choose>
            <when test="sort == 'createdAtAsc'">
                ORDER BY created_at ASC
            </when>
            <when test="sort == 'viewDesc'">
                ORDER BY view_count DESC, created_at DESC
            </when>
            <otherwise>
                ORDER BY created_at DESC
            </otherwise>
        </choose>

        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- 2) 목록 total count -->
    <select id="countPosts" resultType="long">
        SELECT COUNT(*)
        FROM board_post
        <where>
            <if test="category != null and category != '' and category != 'all'">
                AND category = #{category}
            </if>

            <if test="dept != null and dept != ''">
                AND dept = #{dept}
            </if>

            <if test="authorid != null and authorid != ''">
                AND author_id = #{authorid}
            </if>

            <if test="q != null and q != ''">
                AND (
                    title LIKE CONCAT('%', #{q}, '%')
                    OR content LIKE CONCAT('%', #{q}, '%')
                    OR author_name LIKE CONCAT('%', #{q}, '%')
                    OR dept LIKE CONCAT('%', #{q}, '%')
                )
            </if>
        </where>
    </select>

    <!-- 3) 상세 조회 -->
    <select id="selectPostById" resultType="com.coreon.board.domain.BoardPost">
        SELECT
        <include refid="BoardPostColumns"/>
        FROM board_post
        WHERE board_id = #{boardId}
    </select>

    <!-- 4) 조회수 증가 -->
    <update id="incrementViewCount">
        UPDATE board_post
        SET view_count = view_count + 1
        WHERE board_id = #{boardId}
    </update>

    <!-- 5) 게시글 저장 -->
    <insert id="insertPost"
            parameterType="com.coreon.board.domain.BoardPost"
            useGeneratedKeys="true"
            keyProperty="boardId">
        INSERT INTO board_post (
            category,
            title,
            content,
            dept,
            author_id,
            author_name
        ) VALUES (
            #{category},
            #{title},
            #{content},
            #{dept},
            #{authorid},
            #{authorname}
        )
    </insert>

    <!-- 6) 작성자 id 조회(게시글 삭제/수정을 위함) -->
    <select id="selectAuthorId" resultType="string">
        SELECT author_id
        FROM board_post
        WHERE board_id = #{boardId}
    </select>

    <!-- 7) 게시글 삭제 -->
    <delete id="deletePostById">
        DELETE FROM board_post
        WHERE board_id = #{boardId}
    </delete>

    <!-- 8) 게시글 수정 -->
    <update id="updatePost" parameterType="com.coreon.board.domain.BoardPost">
        UPDATE board_post
        <set>
            <if test="category != null and category != ''">
                category = #{category},
            </if>
            <if test="title != null and title != ''">
                title = #{title},
            </if>
            <if test="content != null">
                content = #{content},
            </if>
            <if test="dept != null and dept != ''">
                dept = #{dept},
            </if>
            updated_at = NOW()
        </set>
        WHERE board_id = #{boardId}
    </update>

</mapper>
